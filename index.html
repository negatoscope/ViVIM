<!DOCTYPE html>
<html lang="en" id="htmlTag">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ViVIM Task</title>
    <link rel="icon" type="image/png" href="images/instructions/icon_clarity.png">
    <link rel="stylesheet" href="css/styles.css">
  </head>
  <body lang="en">
    <div id="globalProgressContainer" class="hidden">
      <div id="globalProgressBar"></div>
    </div>

    <div id="languageSelector">
      <button data-lang="en">English</button>
      <button data-lang="es">Espa√±ol</button>
    </div>

    <div id="mainMenu" class="main-container">
      <h1 data-lang-key="mainMenuTitle"></h1>
      <div class="instruction-content">
      <p data-lang-key="mainMenuWelcome"></p>
      </div>
      <button id="testParameterBtn" data-lang-key="testParamButton"></button
      ><br />
      <button id="testVVIQBtn">VVIQ-2</button><br />
      <button id="startActualTaskBtn" data-lang-key="startTaskButton"></button>
      <p
        id="setInfo"
        style="margin-top: 20px; font-size: 12px; color: #888"
      ></p>
      <div
        class="vviq-toggle"
        style="margin-top: 25px; padding-top: 15px; border-top: 1px solid #eee"
      >
        <label>
          <input type="checkbox" id="vviqCheckbox" checked />
          <span data-lang-key="vviqCheckboxLabel"
            >Include VVIQ-2 Questionnaire</span
          >
        </label>
      </div>
    </div>

    <!-- The Welcome Screen -->
    <div id="welcomeScreen" class="main-container hidden">
      <h1 data-lang-key="welcomeTitle">Welcome!</h1>
      <div class="instruction-content">
      <p data-lang-key="welcomeInstructions"></p>
      </div>
      <button id="welcomeContinueBtn" data-lang-key="continueButton">
        Continue
      </button>
      <button
        class="back-button back-to-menu-btn"
        data-lang-key="backToMenuButton"
      ></button>
    </div>

    <!-- Visual Calibration Screen -->
    <div id="visualCalibrationScreen" class="main-container hidden">
      <h1 data-lang-key="calibrationTitle"></h1>
      <div class="instruction-content">
        <p data-lang-key="calibrationInstructions"></p>
      </div>
      
      <div class="calibration-container">
          <div class="calibration-target"></div>
      </div>

      <button id="calibrationContinueBtn" data-lang-key="continueButton">Continue</button>
    </div>

    <!-- The How-To Explanation Screen -->
    <div id="howToScreen" class="main-container hidden">
      <h2 data-lang-key="howToTitle">How the Task Works</h2>
      <div class="instruction-content">
        <p data-lang-key="howToStep1"></p>
      </div>
      <img id="sourceDiagramImg" src="" alt="Diagram showing the three image sources" class="instruction-diagram">
      <button id="howToContinueBtn" data-lang-key="startPracticeButton">
        Start Practice Round
      </button>
    </div>

    <!-- ADD THESE THREE NEW INSTRUCTION SCREENS -->
    <div id="perceptualRecallIntroScreen" class="main-container hidden">
      <img src="images/instructions/icon_perceptual.png" class="header-icon" alt="Remember Photo Icon">
      <h2 data-lang-key="perceptualIntroTitle"></h2>
      <div class="instruction-content">
        <p data-lang-key="perceptualIntroText"></p>
      </div>
      <button id="perceptualIntroContinueBtn" data-lang-key="continueButton">Continue</button>
    </div>

    <div id="episodicRecallIntroScreen" class="main-container hidden">
      <img src="images/instructions/icon_memory.png" class="header-icon" alt="Recall Memory Icon">
      <h2 data-lang-key="episodicIntroTitle"></h2>
      <div class="instruction-content">
        <p data-lang-key="episodicIntroText"></p>
      </div>
      <button id="episodicIntroContinueBtn" data-lang-key="continueButton">Continue</button>
    </div>

    <div id="sceneImaginationIntroScreen" class="main-container hidden">
      <img src="images/instructions/icon_imagination.png" class="header-icon" alt="Imagine Scene Icon">
      <h2 data-lang-key="imaginationIntroTitle"></h2>
      <div class="instruction-content">
        <p data-lang-key="imaginationIntroText"></p>
      </div>
      <button id="imaginationIntroContinueBtn" data-lang-key="continueButton">Continue</button>
    </div>
    
    <div id="flowIntroScreen" class="main-container hidden">
      <h2 data-lang-key="flowIntroTitle"></h2>
      <div class="instruction-content">
        <p data-lang-key="flowIntroText"></p>
        <img id="flowDiagramImg" src="" alt="Diagram showing the rating process" class="instruction-diagram">
      </div>
      <button id="flowIntroContinueBtn" data-lang-key="continueButton">Continue</button>
    </div>

    <div id="approximationIntroScreen" class="main-container hidden">
      <h2 data-lang-key="approximationIntroTitle"></h2>
      <div class="instruction-content">
        <p data-lang-key="approximationIntroText"></p>
      </div>
      <button id="approximationIntroContinueBtn" data-lang-key="continueButton">Continue</button>
    </div>

    <div id="quizScreen" class="main-container hidden">
      <h2 data-lang-key="quizTitle"></h2>
      <div class="instruction-content">
        <p data-lang-key="quizInstructions"></p>
        <!-- Quiz questions will be dynamically inserted here by JavaScript -->
        <div id="quizQuestionsContainer"></div>
        <!-- This is the error message, initially hidden -->
        <p id="quizErrorMessage" class="hidden" style="color: red; font-weight: bold; margin-top: 20px;"></p>
        <!-- THIS IS THE NEW SUCCESS MESSAGE ELEMENT -->
        <p id="quizSuccessMessage" class="hidden" style="color: green; font-weight: bold; margin-top: 20px;"></p>
      </div>
      <button id="quizContinueBtn" data-lang-key="continueButton">Continue</button>
    </div>
    <!-- END OF NEW SCREENS -->

    <!-- Screen 3: Parameter Intro -->
    <div id="paramIntroScreen" class="main-container hidden">
      <h2 data-lang-key="paramIntroTitle"></h2>
      <div class="instruction-content">
      <p data-lang-key="paramIntroText"></p>
      </div>
      <img id="qualitiesDiagramImg" src="" alt="Diagram showing the six visual qualities" class="instruction-diagram">
      <button
        id="paramIntroContinueBtn"
        data-lang-key="continueButton"
      ></button>
      <button
        class="back-button back-to-menu-btn"
        data-lang-key="backToMenuButton"
      ></button>
    </div>

    <!-- Screen 4: Interactive Parameter Demos -->
    <div id="paramDemoScreen" class="split-container hidden">
      <div class="image-panel">
        <!-- This wrapper is the key to correct sizing -->
        <div class="image-display">
          <img id="paramDemoImg" src="" />
        </div>
      </div>
      <div class="controls-panel">
        <img
          id="paramDemoIcon"
          class="header-icon"
          src=""
          alt="Parameter Demo Icon"
        />
        <h2 id="paramDemoTitle"></h2>
        <p id="paramDemoText"></p>
        <div class="flex-spacer"></div>
        <input type="range" id="paramDemoSlider" min="1" max="21" value="11" />
        <div class="flex-spacer"></div>
        <div id="demoActionButtons">
            <button id="prevDemoBtn" data-lang-key="backButton" class="hidden">Back</button>
            <button id="nextDemoBtn" data-lang-key="continueButton"></button>
        </div>
        <button
          class="back-button back-to-menu-btn"
          data-lang-key="backToMenuButton"
        ></button>
      </div>
    </div>

    <!-- Screen 11: Practice Intro -->
    <div id="practiceIntroScreen" class="main-container hidden">
      <h2 data-lang-key="practiceIntroTitle"></h2>
      <div class="instruction-content">
      <p data-lang-key="practiceIntroText"></p>
      </div>
      <button
        id="practiceIntroContinueBtn"
        data-lang-key="continueButton"
      ></button>
      <button
        class="back-button back-to-menu-btn"
        data-lang-key="backToMenuButton"
      ></button>
    </div>

    <!-- ADD THIS NEW SCREEN for the Tutorial Prompt -->
    <div id="tutorialPromptScreen" class="main-container hidden">
      <img id="tutorialPromptIcon" class="header-icon" src="" alt="Tutorial Icon">  
      <h2 data-lang-key="tutorialPromptTitle"></h2>
      <div class="instruction-content">
        <p data-lang-key="tutorialPromptText"></p>
        </div>
        <button id="tutorialStartBtn" data-lang-key="continueButton"></button>
        <button class="back-button back-to-menu-btn" data-lang-key="backToMenuButton"></button>
    </div>

    <div id="readyScreen" class="main-container hidden">
      <h2 data-lang-key="readyTitle"></h2>
      <div class="instruction-content">
      <p data-lang-key="readyText"></p>
      </div>
      <button
        id="startExperimentBtn"
        data-lang-key="startExperimentButton"
      ></button>
    </div>

    <div id="breakScreen" class="main-container hidden">
      <h2 data-lang-key="breakTitle"></h2>
      <p data-lang-key="breakText"></p>
      <p
        id="breakTimerDisplay"
        style="font-size: 24px; font-weight: bold; margin: 20px 0"
      ></p>
      <button id="breakContinueBtn" data-lang-key="continueButton"></button>
    </div>

    <div id="parameterSelector" class="main-container hidden">
      <h2 data-lang-key="paramSelectorTitle"></h2>
      <div id="paramButtonsContainer"></div>
      <button
        id="backToMenuFromTestSelectBtn"
        class="back-button back-to-menu-btn"
        data-lang-key="backToMenuButton"
      ></button>
    </div>

    <div id="conditionInstructionScreen" class="main-container hidden">
      <img id="conditionIcon" class="header-icon" src="" alt="Condition Icon" />
      <h2 id="conditionInstructionTitle"></h2>
      <p id="conditionInstructionText"></p>
      <button
        id="startTrialFromInstructionsBtn"
        data-lang-key="trialContinueButton"
      ></button>
    </div>

    <!-- This container now uses the 'split-container' class for the two-panel layout -->
    <div id="preVimScreenContainer" class="split-container hidden">
      <!-- The LEFT panel will hold the visual stimuli (fixation and image) -->
      <div class="image-panel">
        <div id="fixationScreen" class="hidden">
          <div id="fixationCross">+</div>
        </div>
        <div id="blinkPromptScreen" class="hidden" style="text-align: center; color: white;">
            <!-- THIS IS THE NEW ICON -->
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="blink-icon">
              <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
            </svg>
            <p class="blink-text" data-lang-key="blinkNowPrompt"></p>
        </div>
        <div id="preVimImageScreenDiv" class="hidden">
          <img id="originalImageDisplay" src="" alt="Original Image" />
        </div>
      </div>

      <!-- The RIGHT panel will hold the text prompt and button -->
      <div class="controls-panel">
        <div id="holdImageInstructionScreen" class="hidden">
          <p id="holdImagePrompt" style="margin-top: 20vh"></p>
          <!-- Added style to vertically center the prompt a bit -->
          <button
            id="holdImageContinueBtn"
            data-lang-key="trialContinueButton"
          ></button>
        </div>
      </div>
    </div>

    <div id="vimTaskInterface" class="split-container hidden">
      <!-- 1. The new LEFT panel for the image -->
      <div class="image-panel">
        <!-- MOVE THE COARSE IMAGE DISPLAY HERE -->
        <div class="image-display" id="coarseImageDisplay">
          <p class="preview-instruction" data-lang-key="coarsePreviewText"></p>
          <img id="coarsePreviewImg" src="" alt="Press Arrow/Hover Mouse" class="hidden" />
        </div>

        <!-- MOVE THE FINE-TUNE IMAGE DISPLAY HERE (and hide it) -->
        <div class="image-display hidden" id="fineTuneImageDisplay">
          <img id="fineTuneImg" src="" alt="Fine-tuned image" />
        </div>
      </div>

      <!-- 2. The new RIGHT panel for the controls -->
      <div class="controls-panel">
        <!-- TOP SECTION -->
        <img
          id="parameterIcon"
          class="header-icon"
          src=""
          alt="Parameter Icon"
        />
        <h2 id="currentParamDisplay">Parameter: <span></span></h2>
        <p id="vimGeneralInstruction"></p>

        <!-- ADD THIS FIRST SPACER to push the middle section down -->
        <div class="flex-spacer"></div>

        <!-- MIDDLE SECTION (Interactive Elements) -->
        <div id="coarseStep" class="coarse-selection control-group">
          <p>
            <span data-lang-key="vimCoarsePrompt" class="hidden"></span>
            <span id="coarseParamName"></span>
          </p>

          <button data-level-key="low">
            <span data-lang-key="coarseButtonLow"></span>
          </button>
          <button data-level-key="mid">
            <span data-lang-key="coarseButtonMid"></span>
          </button>
          <button data-level-key="high">
            <span data-lang-key="coarseButtonHigh"></span>
          </button>

          <button
            id="noInfoBtn"
            class="no-info-button"
            data-lang-key="noInfoLabel"
          ></button>
        </div>

        <div id="fineTuneStep" class="fine-tuning control-group hidden">
          <p>
            <span data-lang-key="fineTunePrompt" class="hidden"></span>
            <span id="fineTuneParamName"></span>
          </p>
          <input type="range" id="fineTuneSlider" min="1" max="7" value="4" />
          <!-- This is the line you correctly fixed -->
          <p class="slider-value-display">
            <span id="fineTuneLevelDisplay"></span>
          </p>
          <!-- NOTE: The two buttons that were here have been moved to the bottom -->
        </div>

        <div id="confidenceStep" class="confidence-rating control-group hidden">
          <p id="confidencePrompt"></p>
          <div class="likert-scale">
            <button class="likert-button" data-value="1">1</button>
            <button class="likert-button" data-value="2">2</button>
            <button class="likert-button" data-value="3">3</button>
            <button class="likert-button" data-value="4">4</button>
            <button class="likert-button" data-value="5">5</button>
            <button class="likert-button" data-value="6">6</button>
            <button class="likert-button" data-value="7">7</button>
          </div>
          <div class="likert-labels">
            <span id="likertLabelLow"></span>
            <span id="likertLabelHigh"></span>
          </div>

          <!-- THIS IS THE NEW WRAPPER FOR THE BOTTOM BUTTONS -->
          <div id="confidenceActionButtons" style="margin-top: 20px;">
            <button id="backToFineTuneBtn" data-lang-key="backButton" class="hidden">Back</button>
          <!-- Duplicate button removed -->
          </div>
        </div>

        <!-- This new spacer element pushes everything below it to the bottom -->
        <div class="flex-spacer"></div>

        <!-- BOTTOM SECTION (Action Buttons) -->
        <div class="controls-bottom">
          <!-- This new wrapper will hold the side-by-side buttons -->
          <div id="fineTuneActionButtons">
            <button
              id="backToCoarseBtn"
              data-lang-key="backToCoarseButton"
            ></button>
            <button
              id="confirmSelectionBtn"
              data-lang-key="confirmLevelButton"
            ></button>
            <button
              id="confirmNoInfoBtn"
              class="hidden"
              data-lang-key="continueButton"
            ></button>
            <button
              id="confirmConfidenceBtn"
              data-lang-key="confirmConfidenceButton"
              class="hidden"
            ></button>
          </div>
          <button
            id="backToMenuFromTaskBtn"
            class="back-button back-to-menu-btn"
            data-lang-key="exitTaskButton"
          ></button>
        </div>
      </div>
    </div>
    
    <!-- ADD THIS ENTIRE NEW BLOCK FOR THE VVIQ -->
    <div id="vviqScreen" class="main-container hidden">
      <!-- VVIQ content will be generated by JavaScript here -->
    </div>

    <div id="resultsDisplay" class="main-container hidden">
      <h2 data-lang-key="resultsTitle"></h2>
      <ul id="resultsList"></ul>
      <!-- --- NEW --- -->
      <p id="saveStatus" style="font-style: italic; color: #555"></p>
      <button id="downloadResultsBtn" data-lang-key="downloadResultsButton">
        Download Results
      </button>
      <button
        id="backToMenuFromResultsBtn"
        class="back-button back-to-menu-btn"
        data-lang-key="backToMenuButton"
      ></button>
    </div>

    <div id="loadingOverlay" class="hidden">
      <div class="loading-box">
        <p id="loadingText">Loading trial...</p>
        <div class="progress-bar-container">
          <div id="progressBar" style="width: 0%"></div>
        </div>
      </div>
    </div>

    <div id="orientationOverlay">
      <div class="orientation-message">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="currentColor"
          class="orientation-icon"
        >
          <path
            d="M16.49,4.26l-1.41,1.41c1.62,1.62,2.5,3.81,2.5,6.08c0,1.39-0.32,2.7-0.91,3.86l1.4,1.42c0.77-1.46,1.18-3.08,1.18-4.83C19.25,8.07,18.27,5.98,16.49,4.26z M17.65,2.85l1.41-1.41C21.32,3.7,22.75,6.2,22.75,9c0,2.18-0.63,4.27-1.76,6.09l-1.46-1.46C20.59,12.13,21.25,10.61,21.25,9C21.25,6.86,20.04,4.9,17.65,2.85z M4.75,9c0-2.27,0.88-4.45,2.5-6.08L5.84,1.51C3.73,3.7,2.75,6.2,2.75,9c0,2.18,0.63,4.27,1.76,6.09l1.46-1.46C5.41,12.13,4.75,10.61,4.75,9z M12,7c-2.21,0-4,1.79-4,4s1.79,4,4,4s4-1.79,4-4S14.21,7,12,7z"
          />
        </svg>
        <p id="orientationText_en">
          For the best experience, please rotate your device to landscape mode.
        </p>
        <p id="orientationText_es">
          Para una mejor experiencia, por favor gire su dispositivo a modo
          horizontal.
        </p>
      </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/state.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/app.js"></script>
  </body>
</html>
